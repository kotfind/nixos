#!/usr/bin/env bash

set -euo pipefail
set -x

CFG_FILE="cfg.nix"

sudo nixos-rebuild switch --flake .#system --verbose

username="$(nix eval --impure --raw --expr "(import ./$CFG_FILE).username")"
gen="$(awk '/ExecStart=/ { print $2; }' /etc/systemd/system/home-manager-"$username".service)"

sudo -u "$username" "$gen/activate"
