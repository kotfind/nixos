#!/usr/bin/env bash

set -euo pipefail

# Actually rebuild system
rebuild() {
    sudo nixos-rebuild switch --flake .#default --verbose
}

# activate a single user "$1"
activate_user() {
    local username="$1"

    echo "-------------------- activate $username --------------------"

    local gen
    gen="$(awk '/ExecStart=/ { print $2; }' /etc/systemd/system/home-manager-"$username".service)"

    rm -f "/home/$username/.config/fcitx5/profile"
    rm -f "/home/$username/.config/fcitx5/config"

    sudo -u "$username" "$gen/activate"
}

# Call activations scripts for all users
activate_all() {
    local script='
        { config, lib, ...}:
            lib.escapeShellArgs
                (builtins.attrNames config.cfgLib.users)'

    local usernames
    usernames=($(nix eval .#nixosConfigurations.default --apply "$script" --raw))

    for username in "${usernames[@]}"; do
        activate_user "$username"
    done
}

run() {
    cd "$(dirname "$0")"
    rebuild
    activate_all
}

run
